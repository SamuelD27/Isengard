name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - smoke
          - training
          - visual
          - quick

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # Quick validation - runs on every PR
  quick-validation:
    name: Quick Validation (Smoke + Training)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            e2e/package-lock.json
            apps/web/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r apps/api/requirements.txt
          pip install httpx
          cd apps/web && npm ci
          cd ../.. && cd e2e && npm ci
          npx playwright install --with-deps chromium

      - name: Start services
        run: |
          cd apps/api
          ISENGARD_MODE=fast-test REDIS_URL=redis://localhost:6379 \
          uvicorn src.main:app --host 0.0.0.0 --port 8000 &
          cd ../web
          VITE_API_URL=http://localhost:8000 npm run dev -- --host --port 3000 &

      - name: Wait for services
        run: |
          echo "Waiting for API..."
          for i in {1..30}; do
            if curl -s http://localhost:8000/health | grep -q healthy; then
              echo "API is ready"
              break
            fi
            sleep 2
          done
          echo "Waiting for frontend..."
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "Frontend is ready"
              break
            fi
            sleep 2
          done

      - name: Run quick tests (smoke + training)
        run: |
          cd e2e
          E2E_BASE_URL=http://localhost:3000 \
          E2E_API_URL=http://localhost:8000 \
          E2E_SKIP_SERVER=1 \
          npx playwright test \
            --project=chromium-desktop \
            --ignore-snapshots \
            tests/smoke/ tests/training-gui.spec.ts

      - name: Upload artifacts on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: quick-validation-artifacts
          path: |
            e2e/artifacts/
            e2e/playwright-report/
          retention-days: 3

  # Full E2E suite - runs on push to main/develop
  e2e-full:
    name: Full E2E Suite
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'all')

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            e2e/package-lock.json
            apps/web/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt

      - name: Install Python dependencies
        run: |
          pip install -r apps/api/requirements.txt
          pip install httpx

      - name: Install frontend dependencies
        run: |
          cd apps/web
          npm ci

      - name: Install E2E dependencies
        run: |
          cd e2e
          npm ci

      - name: Install Playwright browsers
        run: |
          cd e2e
          npx playwright install --with-deps chromium

      - name: Start API server
        run: |
          cd apps/api
          ISENGARD_MODE=fast-test REDIS_URL=redis://localhost:6379 \
          uvicorn src.main:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Wait for API
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:8000/health | grep -q healthy; then
              echo "API is ready"
              break
            fi
            echo "Waiting for API..."
            sleep 2
          done

      - name: Start frontend
        run: |
          cd apps/web
          VITE_API_URL=http://localhost:8000 npm run dev -- --host --port 3000 &
          sleep 10

      - name: Wait for frontend
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:3000 > /dev/null; then
              echo "Frontend is ready"
              break
            fi
            echo "Waiting for frontend..."
            sleep 2
          done

      - name: Run E2E tests
        run: |
          cd e2e
          E2E_BASE_URL=http://localhost:3000 \
          E2E_API_URL=http://localhost:8000 \
          E2E_SKIP_SERVER=1 \
          npx playwright test --project=chromium-desktop --ignore-snapshots

      - name: Show failure report
        if: failure()
        run: |
          if [ -f e2e/artifacts/reports/FAILURE_REPORT.txt ]; then
            echo "=== FAILURE REPORT ==="
            cat e2e/artifacts/reports/FAILURE_REPORT.txt
          fi

      - name: List artifacts
        if: always()
        run: |
          echo "=== Artifacts generated ==="
          find e2e/artifacts -type f 2>/dev/null | head -50 || echo "No artifacts found"

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-test-results
          path: |
            e2e/artifacts/
            e2e/playwright-report/
          retention-days: 7

      - name: Upload Playwright HTML report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-html-report
          path: e2e/playwright-report/
          retention-days: 7

  # Visual regression tests - runs on push to main
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            e2e/package-lock.json
            apps/web/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        run: |
          pip install -r apps/api/requirements.txt
          pip install httpx
          cd apps/web && npm ci
          cd ../.. && cd e2e && npm ci
          npx playwright install --with-deps chromium

      - name: Start services
        run: |
          cd apps/api
          ISENGARD_MODE=fast-test REDIS_URL=redis://localhost:6379 \
          uvicorn src.main:app --host 0.0.0.0 --port 8000 &
          cd ../web
          VITE_API_URL=http://localhost:8000 npm run dev -- --host --port 3000 &

      - name: Wait for services
        run: |
          for i in {1..30}; do
            curl -s http://localhost:8000/health | grep -q healthy && break
            sleep 2
          done
          for i in {1..30}; do
            curl -s http://localhost:3000 > /dev/null && break
            sleep 2
          done

      - name: Run visual regression tests
        run: |
          cd e2e
          E2E_BASE_URL=http://localhost:3000 \
          E2E_API_URL=http://localhost:8000 \
          E2E_SKIP_SERVER=1 \
          npx playwright test --project=chromium-desktop tests/visual/

      - name: Upload visual diff artifacts
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-regression-diffs
          path: |
            e2e/artifacts/
            e2e/playwright-report/
          retention-days: 7

  # Training GUI tests - can be triggered manually
  training-gui:
    name: Training GUI Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.test_type == 'training'

    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install -r apps/api/requirements.txt
          pip install httpx
          cd apps/web && npm ci
          cd ../.. && cd e2e && npm ci
          npx playwright install --with-deps chromium

      - name: Start services
        run: |
          cd apps/api
          ISENGARD_MODE=fast-test REDIS_URL=redis://localhost:6379 \
          uvicorn src.main:app --host 0.0.0.0 --port 8000 &
          cd ../web
          VITE_API_URL=http://localhost:8000 npm run dev -- --host --port 3000 &
          sleep 15

      - name: Run training GUI tests
        run: |
          cd e2e
          E2E_BASE_URL=http://localhost:3000 \
          E2E_API_URL=http://localhost:8000 \
          E2E_SKIP_SERVER=1 \
          npx playwright test --project=chromium-desktop tests/training-gui.spec.ts

      - name: Upload artifacts on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: training-gui-artifacts
          path: |
            e2e/artifacts/
            e2e/playwright-report/
          retention-days: 3
