# Isengard API Contract

This document defines the API contract between frontend and backend. All endpoints, request/response schemas, and expected behaviors are documented here.

## Base URL

| Environment | URL |
|-------------|-----|
| Development | `http://localhost:8000` |
| Production | `https://api.isengard.app` (via proxy) |

## Common Headers

### Request Headers

| Header | Required | Description |
|--------|----------|-------------|
| `X-Correlation-ID` | No | Unique ID for request tracing. Generated by server if not provided. |
| `Content-Type` | Yes* | `application/json` for JSON bodies, `multipart/form-data` for file uploads |

### Response Headers

| Header | Description |
|--------|-------------|
| `X-Correlation-ID` | Same as request or server-generated |

## Error Response Format

All errors follow this format:

```json
{
  "detail": "Human-readable error message"
}
```

HTTP status codes:
- `400` - Bad Request (validation errors)
- `404` - Not Found
- `429` - Rate Limited
- `500` - Internal Server Error
- `503` - Service Unavailable

---

## Health Endpoints

### GET /health

Basic health check.

**Response 200:**
```json
{
  "status": "healthy"
}
```

### GET /ready

Readiness check with dependencies.

**Response 200:**
```json
{
  "status": "ready",
  "mode": "fast-test",
  "dependencies": {
    "redis": "ok",
    "storage": "ok"
  }
}
```

### GET /info

API capabilities and plugin schemas.

**Response 200:**
```json
{
  "name": "Isengard API",
  "version": "0.1.0",
  "mode": "fast-test",
  "training": {
    "method": "lora",
    "backend": "ai-toolkit",
    "parameters": {
      "steps": {
        "type": "int",
        "min": 100,
        "max": 10000,
        "default": 1000,
        "wired": true,
        "description": "Number of training steps"
      }
      // ... more parameters
    }
  },
  "image_generation": {
    "backend": "comfyui",
    "model_variants": ["flux-schnell", "flux-dev"],
    "toggles": {
      "use_controlnet": {
        "supported": false,
        "reason": "Not implemented"
      }
      // ... more toggles
    },
    "parameters": {
      "steps": {
        "type": "int",
        "min": 1,
        "max": 100,
        "default": 20,
        "wired": true
      }
      // ... more parameters
    }
  }
}
```

---

## Character Endpoints

### GET /api/characters

List all characters.

**Response 200:**
```json
[
  {
    "id": "char-abc123",
    "name": "John Smith",
    "description": "Test character",
    "trigger_word": "johnsmith_person",
    "created_at": "2025-01-15T10:30:00.000Z",
    "updated_at": "2025-01-15T10:30:00.000Z",
    "image_count": 15,
    "lora_path": null,
    "lora_trained_at": null
  }
]
```

### POST /api/characters

Create a new character.

**Request Body:**
```json
{
  "name": "John Smith",
  "description": "Optional description",
  "trigger_word": "johnsmith_person"
}
```

**Response 201:**
```json
{
  "id": "char-abc123",
  "name": "John Smith",
  "description": "Optional description",
  "trigger_word": "johnsmith_person",
  "created_at": "2025-01-15T10:30:00.000Z",
  "updated_at": "2025-01-15T10:30:00.000Z",
  "image_count": 0,
  "lora_path": null,
  "lora_trained_at": null
}
```

### GET /api/characters/{id}

Get character by ID.

**Response 200:** Same as character object above.

**Response 404:**
```json
{
  "detail": "Character char-xxx not found"
}
```

### PATCH /api/characters/{id}

Update character.

**Request Body (all fields optional):**
```json
{
  "name": "Updated Name",
  "description": "Updated description",
  "trigger_word": "updated_trigger"
}
```

**Response 200:** Updated character object.

### DELETE /api/characters/{id}

Delete character.

**Response 204:** No content.

### POST /api/characters/{id}/images

Upload training images.

**Request:** `multipart/form-data` with `files` field containing images.

**Response 201:**
```json
{
  "uploaded": ["image1.jpg", "image2.png"],
  "rejected": [
    {"filename": "bad.gif", "reason": "Invalid image type"}
  ],
  "total_images": 2
}
```

### GET /api/characters/{id}/images

List character's images.

**Response 200:**
```json
{
  "images": ["image1.jpg", "image2.png"],
  "count": 2
}
```

### GET /api/characters/{id}/images/{filename}

Serve image file.

**Response 200:** Image binary with appropriate `Content-Type`.

### DELETE /api/characters/{id}/images/{filename}

Delete an image.

**Response 204:** No content.

---

## Training Endpoints

### GET /api/training

List training jobs.

**Query Parameters:**
- `character_id` (optional): Filter by character

**Response 200:**
```json
[
  {
    "id": "train-abc123",
    "character_id": "char-xyz789",
    "status": "completed",
    "config": {
      "method": "lora",
      "steps": 1000,
      "learning_rate": 0.0001,
      "batch_size": 1,
      "resolution": 1024,
      "lora_rank": 16
    },
    "progress": 100,
    "current_step": 1000,
    "total_steps": 1000,
    "error_message": null,
    "created_at": "2025-01-15T10:30:00.000Z",
    "started_at": "2025-01-15T10:31:00.000Z",
    "completed_at": "2025-01-15T11:00:00.000Z",
    "output_path": "/data/loras/char-xyz789/v1.safetensors"
  }
]
```

### POST /api/training

Start a training job.

**Request Body:**
```json
{
  "character_id": "char-xyz789",
  "config": {
    "method": "lora",
    "steps": 1000,
    "learning_rate": 0.0001,
    "batch_size": 1,
    "resolution": 1024,
    "lora_rank": 16,
    "optimizer": "adamw8bit",
    "scheduler": "cosine",
    "precision": "bf16"
  }
}
```

**Response 201:** Training job object.

**Response 400:**
```json
{
  "detail": "No training images uploaded for this character"
}
```

**Response 404:**
```json
{
  "detail": "Character char-xxx not found"
}
```

### GET /api/training/{id}

Get training job status.

**Response 200:** Training job object.

### GET /api/training/{id}/stream

Server-Sent Events stream for job progress.

**Event Format:**
```
event: progress
data: {"job_id":"train-abc123","job_type":"training","status":"running","progress":45,"message":"Step 450/1000","current_step":450,"total_steps":1000}

event: complete
data: {"job_id":"train-abc123","job_type":"training","status":"completed","progress":100,"message":"Training complete"}
```

### POST /api/training/{id}/cancel

Cancel a training job.

**Response 200:** Updated job with `status: "cancelled"`.

**Response 400:**
```json
{
  "detail": "Cannot cancel job in completed state"
}
```

---

## Generation Endpoints

### GET /api/generation

List generation jobs.

**Query Parameters:**
- `limit` (optional): Max results (default: 20)

**Response 200:**
```json
[
  {
    "id": "gen-abc123",
    "status": "completed",
    "config": {
      "prompt": "A portrait photo",
      "negative_prompt": "blurry",
      "width": 1024,
      "height": 1024,
      "steps": 20,
      "guidance_scale": 3.5,
      "seed": 12345,
      "lora_id": "char-xyz789",
      "lora_strength": 1.0,
      "use_controlnet": false,
      "use_ipadapter": false,
      "use_facedetailer": false,
      "use_upscale": false
    },
    "progress": 100,
    "error_message": null,
    "created_at": "2025-01-15T10:30:00.000Z",
    "output_paths": ["/data/outputs/gen-abc123-0.png"]
  }
]
```

### POST /api/generation

Start a generation job.

**Request Body:**
```json
{
  "config": {
    "prompt": "A portrait photo of johnsmith_person",
    "negative_prompt": "blurry, distorted",
    "width": 1024,
    "height": 1024,
    "steps": 20,
    "guidance_scale": 3.5,
    "seed": null,
    "lora_id": "char-xyz789",
    "lora_strength": 1.0,
    "use_controlnet": false,
    "use_ipadapter": false,
    "use_facedetailer": false,
    "use_upscale": false
  },
  "count": 1
}
```

**Response 201:** Generation job object.

### GET /api/generation/{id}

Get generation job status.

**Response 200:** Generation job object.

### GET /api/generation/{id}/stream

SSE stream for generation progress (same format as training).

### POST /api/generation/{id}/cancel

Cancel a generation job.

**Response 200:** Updated job with `status: "cancelled"`.

### GET /api/generation/output/{filename}

Serve generated image.

**Response 200:** Image binary.

---

## Job Utility Endpoints

### GET /api/jobs/{id}/logs

Get job log file.

**Response 200:** `text/plain` log content (JSONL format).

**Response 404:**
```json
{
  "detail": "Job logs not found"
}
```

---

## Client Logs Endpoint

### POST /api/client-logs

Submit client-side logs.

**Request Body:**
```json
{
  "entries": [
    {
      "timestamp": "2025-01-15T10:30:00.000Z",
      "level": "ERROR",
      "message": "Button click failed",
      "event": "ui.error",
      "context": {
        "page": "/characters",
        "button": "create"
      }
    }
  ]
}
```

**Response 200/204:** Success.

---

## Rate Limits

| Endpoint | Limit |
|----------|-------|
| POST /api/characters/{id}/images | 30 req/min |
| POST /api/training | 5 req/min |
| POST /api/generation | 20 req/min |

**Response 429:**
```json
{
  "detail": "Rate limit exceeded. Try again in X seconds."
}
```

---

## TypeScript Types (Frontend)

```typescript
interface Character {
  id: string
  name: string
  description: string | null
  trigger_word: string
  created_at: string
  updated_at: string
  image_count: number
  lora_path: string | null
  lora_trained_at: string | null
}

interface TrainingConfig {
  method: 'lora'
  steps: number
  learning_rate: number
  batch_size: number
  resolution: number
  lora_rank: number
  optimizer?: string
  scheduler?: string
  precision?: string
}

interface TrainingJob {
  id: string
  character_id: string
  status: 'pending' | 'queued' | 'running' | 'completed' | 'failed' | 'cancelled'
  config: TrainingConfig
  progress: number
  current_step: number
  total_steps: number
  error_message: string | null
  created_at: string
  started_at: string | null
  completed_at: string | null
  output_path: string | null
}

interface GenerationConfig {
  prompt: string
  negative_prompt: string
  width: number
  height: number
  steps: number
  guidance_scale: number
  seed: number | null
  lora_id: string | null
  lora_strength: number
  use_controlnet?: boolean
  use_ipadapter?: boolean
  use_facedetailer?: boolean
  use_upscale?: boolean
}

interface GenerationJob {
  id: string
  status: 'pending' | 'queued' | 'running' | 'completed' | 'failed' | 'cancelled'
  config: GenerationConfig
  progress: number
  error_message: string | null
  created_at: string
  output_paths: string[]
}
```

---

## Known Issues & Fixes

### Issue 1: Health Endpoints Not Under /api Prefix

**Problem:** Frontend calls `/api/health` but backend serves at `/health`.

**Status:** NEEDS FIX

**Solution:** Either:
1. Add `/api` prefix to health router in main.py, OR
2. Update frontend api.ts to call `/health` without API_BASE prefix

### Issue 2: Generation Output Path Format

**Problem:** Frontend expects `output_paths` to be filenames, but backend may return full paths.

**Status:** Verify during testing.

---

*Last updated: 2025-01-15*
