# Isengard E2E Testing

Comprehensive end-to-end GUI testing for Isengard using Playwright.

## Quick Start

```bash
# Install dependencies and browsers
cd e2e
npm install
npx playwright install --with-deps

# Run tests (requires services running)
npm test

# Or use the all-in-one runner (starts services automatically)
./scripts/e2e-run.sh
```

## Commands

| Command | Description |
|---------|-------------|
| `npm test` | Run all tests headless |
| `npm run test:headed` | Run with visible browser |
| `npm run test:ui` | Interactive Playwright UI mode |
| `npm run test:smoke` | Quick smoke tests only |
| `npm run test:training` | Training flow tests only |
| `npm run test:debug` | Debug mode with inspector |
| `npm run report` | Open HTML report |
| `npm run update-snapshots` | Update visual baselines |

## Test Categories

### Smoke Tests (`@smoke`)
Quick sanity checks that run on all browsers:
- App loads without JS errors
- Navigation works
- API health check passes
- No misrouted API calls (HTML instead of JSON)

### Flow Tests
Full user journey tests:
- **Characters**: Create, view, delete characters
- **Training**: Configure, start, observe progress
- **Generation**: Configure, generate, view outputs

### Edge Case Tests
Error handling and race condition tests:
- API 500 errors show error message
- Slow API shows loading state
- Double-click prevention
- Network loss recovery

### Visual Tests (`@visual`)
Screenshot-based regression tests:
- Characters page (empty, populated)
- Training page (idle, with jobs)
- Error states

## Running Locally

### Option 1: Use the Runner Script (Recommended)

```bash
# Full test run
./scripts/e2e-run.sh

# Smoke tests only
./scripts/e2e-run.sh --smoke

# Headed mode (see the browser)
./scripts/e2e-run.sh --headed

# Specific test file
./scripts/e2e-run.sh --file flows/training.spec.ts

# Debug mode
./scripts/e2e-run.sh --debug

# Skip starting services (if already running)
./scripts/e2e-run.sh --skip-services
```

### Option 2: Manual Setup

1. Start services:
```bash
docker-compose up -d redis api web
# Or manually:
cd apps/api && uvicorn src.main:app --port 8000
cd apps/web && npm run dev
```

2. Run tests:
```bash
cd e2e
E2E_SKIP_SERVER=1 npm test
```

## Artifacts

All artifacts are stored in `e2e/artifacts/`:

```
artifacts/
├── test-results/           # Per-test artifacts (auto-generated by Playwright)
│   └── <test-name>/
│       ├── test-failed-1.png   # Screenshot on failure
│       ├── video.webm          # Video recording
│       └── trace.zip           # Playwright trace
├── reports/
│   ├── FAILURE_REPORT.txt  # Human-readable failure summary
│   ├── failures.json       # Structured failure data
│   └── test-results.json   # Full test results (JSON)
├── screenshots/            # (reserved for manual screenshots)
├── videos/                 # (reserved for manual videos)
├── traces/                 # (reserved for manual traces)
└── har/                    # (reserved for HAR files)
```

### Artifact Behavior

- **Screenshots**: Captured automatically on failure (`screenshot: 'on'`)
- **Videos**: Recorded for all tests (`video: 'on'`)
- **Traces**: Captured for all tests (`trace: 'on'`)

### View Artifacts

```bash
# View failure report
cat e2e/artifacts/reports/FAILURE_REPORT.txt

# Open HTML report (interactive)
cd e2e && npx playwright show-report

# View a trace (interactive)
npx playwright show-trace e2e/artifacts/test-results/<test-name>/trace.zip

# List all screenshots
find e2e/artifacts/test-results -name "*.png"

# List all videos
find e2e/artifacts/test-results -name "*.webm"
```

## Debugging Failures

### Quick Checks

```bash
# View failure summary
cat e2e/artifacts/reports/FAILURE_REPORT.txt

# Open interactive HTML report
cd e2e && npx playwright show-report

# View trace for a failed test
npx playwright show-trace e2e/artifacts/test-results/<test-name>/trace.zip
```

### Debug a Specific Test

```bash
PWDEBUG=1 npx playwright test "should create a character" --headed
```

## Writing Tests

### Test Structure

```typescript
import { test, expect } from '../../fixtures/test-fixtures';

test.describe('Feature Name @tag', () => {
  test('should do something', async ({ page, charactersPage }) => {
    // Use page objects for clarity
    await charactersPage.goto();
    await charactersPage.clickNewCharacter();

    // Assert specific conditions
    await expect(charactersPage.nameInput).toBeVisible();
  });
});
```

### Using Page Objects

Page objects encapsulate page-specific selectors and actions:

```typescript
// pages/characters.page.ts
export class CharactersPage extends BasePage {
  readonly newCharacterBtn = this.page.locator('[data-testid="new-character-btn"]');

  async createCharacter(options) {
    await this.clickNewCharacter();
    await this.fillCharacterForm(options);
    return this.submitCharacterForm();
  }
}
```

### Wait Strategies

**DON'T use arbitrary timeouts:**
```typescript
// BAD
await page.waitForTimeout(2000);
await page.waitForLoadState('networkidle');
```

**DO wait for specific conditions:**
```typescript
// GOOD
await expect(page.getByTestId('character-card')).toBeVisible();
await expect(button).toBeEnabled();
const response = await page.waitForResponse(r => r.url().includes('/api/characters'));
```

### Adding Test IDs

When adding new UI elements, include `data-testid`:

```tsx
<Button data-testid="submit-btn" onClick={handleSubmit}>
  Submit
</Button>
```

## Visual Regression Testing

### Update Baselines

When UI intentionally changes:

```bash
npm run update-snapshots
```

### Baseline Location

Baselines are stored in `e2e/baselines/` and should be committed to git.

## CI Integration

Tests run automatically on:
- Push to `main` or `develop`
- Pull requests to `main` or `develop`

See `.github/workflows/e2e-tests.yml` for the workflow configuration.

### Viewing CI Results

1. Go to the GitHub Actions tab
2. Click on the workflow run
3. Download the `e2e-test-results` artifact for screenshots/videos/traces

## Troubleshooting

### Tests timeout waiting for services

Make sure services are running:
```bash
curl http://localhost:8000/health
curl http://localhost:3000
```

### API calls return HTML instead of JSON

This indicates a routing issue. The frontend server may be serving the SPA instead of proxying to the API. Check:
1. Vite proxy configuration in `apps/web/vite.config.ts`
2. API server is running on the expected port

### Visual tests fail on different environments

Visual tests may have small differences across environments. Use the `maxDiffPixels` option:
```typescript
await expect(page).toHaveScreenshot('name.png', { maxDiffPixels: 100 });
```

### Tests are flaky

1. Check for race conditions in the app
2. Use explicit waits instead of arbitrary timeouts
3. Ensure test data isolation (each test should clean up after itself)

### No artifacts generated on failure

If tests fail but no screenshots/videos/traces appear:
1. Check that `e2e/artifacts/` directory exists
2. Verify playwright.config.ts has correct settings:
   - `outputDir: 'artifacts/test-results'`
   - `screenshot: 'on'` or `'only-on-failure'`
   - `video: 'on'` or `'retain-on-failure'`
   - `trace: 'on'` or `'retain-on-failure'`
3. Ensure tests are running from the `e2e/` directory
